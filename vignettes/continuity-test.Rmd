---
title: "continuity-test"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{continuity-test}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


```{r}
# Set to FALSE if modifications in the code are expected to alter the model results 
# compared to the results obtained with the master branch
# If set to FALSE to merge a PR, the merge should then be followed by a 
# reactivation PR setting this value back to TRUE.
USE_AS_TEST <- FALSE 


# Default input folder is the test data
# ST_INPUTS_FOLDER <- fs::path("..","tests","testthat","test_data","ST_INPUTS_DEV")
ST_INPUTS_FOLDER <- fs::path("..","workspace","st_inputs_sampled")
```


# Get ST results from current branch

```{r setup}
library(dplyr)
library(ggplot2)
library(tidyr)
library(scales)

if (requireNamespace("r2dii.climate.stress.test", quietly = TRUE)){
  remove.packages("r2dii.climate.stress.test")
}
devtools::install(upgrade="never")
library(r2dii.climate.stress.test)
```

```{r message=FALSE}
st_results_branch <- r2dii.climate.stress.test::run_trisk(input_path = ST_INPUTS_FOLDER, output_path = tempdir(), return_results = TRUE)
```

# Uninstall current branch and install ST from master branch

```{r message=FALSE}
detach("package:r2dii.climate.stress.test", unload=TRUE)
remove.packages("r2dii.climate.stress.test")
devtools::install_github("2DegreesInvesting/r2dii.climate.stress.test", upgrade = "never")
```

# Get ST results from master branch

```{r}
library(r2dii.climate.stress.test)
```


```{r message=FALSE}
st_results_master<- r2dii.climate.stress.test::run_trisk(input_path = ST_INPUTS_FOLDER, output_path = tempdir(), return_results = TRUE)
```
# Compare results



```{r}
new_crispy <- st_results_branch$crispy_output %>%
  select(
    company_id,
    company_name,
    ald_sector,
    ald_business_unit,
    term,
    net_present_value_baseline,
    net_present_value_shock,
    pd_baseline,
    pd_shock
  )

old_crispy <- st_results_master$crispy_output %>%
  select(
    company_id,
    company_name,
    ald_sector,
    ald_business_unit,
    term,
    net_present_value_baseline,
    net_present_value_shock,
    pd_baseline,
    pd_shock
  )


crispy_comparison <- dplyr::inner_join(old_crispy, new_crispy)

if (USE_AS_TEST) {
  crispy_comparison %>%
    assertr::verify(nrow(.) == nrow(old_crispy))
}

```
# Inquire

```{r}
mix <- dplyr::inner_join(old_crispy, new_crispy, by=c("company_id", "company_name", "ald_sector", "ald_business_unit", "term"))

# List of root names based on your data frame
roots <- c("net_present_value_baseline", "net_present_value_shock", "pd_baseline", "pd_shock")

# Iterate over each root name
for(root in roots) {
  x_col <- paste0(root, ".x")
  y_col <- paste0(root, ".y")

  # Subtract and create new column, remove old columns
  mix <- mix %>%
    mutate(!!paste0(root, "_diff") := !!sym(x_col) - !!sym(y_col)) %>%
    select(-!!sym(x_col), -!!sym(y_col))
}
```

```{r, fig.height=6, fig.width=8}

# Assuming your dataframe is named df
df <- mix

# Replace zeros with NAs in _diff columns, except those completely filled with zeros
diff_cols <- grep("_diff$", names(df), value = TRUE)
for(col in diff_cols) {
  if(all(df[[col]] == 0)) next
  df[[col]][df[[col]] == 0] <- NA
}

# Reshape the dataframe for plotting
long_df <- df %>%
  select(contains("_diff")) %>%
  pivot_longer(cols = everything(), names_to = "variable", values_to = "value")



# Plot distribution plots for each _diff column with scientific notation on x-axis
ggplot(long_df, aes(x = value, fill = variable)) +
  geom_histogram(bins = 30, position = "identity", alpha = 0.6) +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  scale_x_continuous(labels = scientific_format(),
                     breaks = scales::pretty_breaks()) +
  labs(title = "Distribution of '_diff' Columns", x = "Value (Scientific Notation)", y = "Count") +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 45, hjust = 1))
```


